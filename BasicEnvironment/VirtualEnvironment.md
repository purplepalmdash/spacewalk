## 虚拟机环境
virt-manager提供了对虚拟机本身及虚拟机运行环境的配置。在virt-manager中可以通过对网络、
存储、网络接口的配置，规划出虚拟机运行的环境。本章我们将对Spacewalk集群运行的网络环境
进行规划，在规划好的网络环境上，我们将安装和配置整个Spacewalk集群。    

### 网络配置
在终端中键入`virt-manager`，我们将得到一个"虚拟系统管理器"的窗口，如图所示:    
![/images/2015_09_08_16_59_49_621x564.jpg](/images/2015_09_08_16_59_49_621x564.jpg)    

双击"localhost(QEMU)",弹出的窗口即为该hypervisor连接详情, 初始化tab里内容为该主机的CPU和
内存负载：    
![/images/2015_09_08_17_05_30_614x523.jpg](/images/2015_09_08_17_05_30_614x523.jpg)    

点击"虚拟网络",进入到virt-manager所管理的网络列表，我们可以看到主机上已经配置好的虚拟网
络列表。点击窗口左下方的加号按钮，创建一个全新的虚拟网络用于部署整个Spacewalk集群:    
![/images/2015_09_08_17_07_39_615x519.jpg](/images/2015_09_08_17_07_39_615x519.jpg)    

在弹出的窗口中，自定义网络名为"SpacewalkNetwork", 而后点击"下一步"进入到步骤二:    
![/images/2015_09_08_17_16_51_450x485.jpg](/images/2015_09_08_17_16_51_450x485.jpg)    

步骤二中我们设置好网络的IP地址范围，以及是否启用DHCP，我们选择"10.17.20.0/24"作为虚拟网
络的地址段，因为Spacewalk服务器本身可以启用DHCP服务器，这里我们选择不开启DHCP服务。设置
完毕后进入到步骤三:        
![/images/2015_09_08_17_20_37_459x454.jpg](/images/2015_09_08_17_20_37_459x454.jpg)      

因为我们不打算开启IPV6的支持，直接进入到下一步:    
![/images/2015_09_08_17_23_17_459x451.jpg](/images/2015_09_08_17_23_17_459x451.jpg)    

开启此网段上的NAT，以便每台加入此网段的机器都能与外界通信，点击完成后，网络配置成功:    
![/images/2015_09_08_17_24_30_456x446.jpg](/images/2015_09_08_17_24_30_456x446.jpg)    

在网络列表中我们可以看到刚才新添加网络的详细配置:    
![/images/2015_09_08_17_26_58_333x282.jpg](/images/2015_09_08_17_26_58_333x282.jpg)    

### Spacewalk根节点虚拟机
下载安装虚拟机所需的光盘文件，Spacewalk支持安装在CentOS6/CentOS7上，我们这里选择CentOS7
作为Spacewalk根节点系统，从国内镜像下载文件可以获得不错的速度:    

```
# wget \ 
http://mirrors.aliyun.com/centos/7/isos/x86_64/CentOS-7-x86_64-Everything-1503-01.iso
```

定义虚拟机所需的硬盘，使用qcow2文件格式，创建一个最大容量为200G的虚拟机硬盘:        

```
# qemu-img create -f qcow2 SpacewalkBook.qcow2 200G
Formatting 'SpacewalkBook.qcow2', fmt=qcow2 size=214748364800 encryption=off
cluster_size=65536 lazy_refcounts=off 
```

在虚拟系统管理器中，点击"创建新虚拟机"按钮，开始进入到新创建虚拟机的配置：    
![/images/2015_09_08_17_28_43_395x152.jpg](/images/2015_09_08_17_28_43_395x152.jpg)   

选择"本地安装介质"，进入到下一步:    
![/images/2015_09_08_17_31_48_397x421.jpg](/images/2015_09_08_17_31_48_397x421.jpg)   

选择到我们刚才下载的CentOS7安装DVD文件，virt-manager将自动侦测操作系统，进入到下一步:    
![/images/2015_09_08_17_44_07_395x432.jpg](/images/2015_09_08_17_44_07_395x432.jpg)

定义虚拟机所需的内存和CPU，4G内存和双核CPU的配置足以运行Spacewalk:   
![/images/2015_09_08_17_46_23_396x422.jpg](/images/2015_09_08_17_46_23_396x422.jpg)    

选择硬盘镜像文件为我们在命令行下创建的qcow2文件:    
![/images/2015_09_08_17_47_30_395x421.jpg](/images/2015_09_08_17_47_30_395x421.jpg)   

在最后一步中，为我们要创建的虚拟机起名，在点击"完成"按钮之前，选上"在安装前自定义配置":    
![/images/2015_09_08_17_48_40_490x424.jpg](/images/2015_09_08_17_48_40_490x424.jpg)   
 
### 自定义虚拟机配置
以下是我们需要对Spacewalk根节点机器进行的自定义及优化配置:    

磁盘性能优化，更改磁盘的以下参数以获得更好的磁盘IO。     
![/images/2015_09_08_17_51_35_510x292.jpg](/images/2015_09_08_17_51_35_510x292.jpg)     

定义虚拟网络接口的相关配置和参数, 选择到我们在上面创建好的网络:    
![/images/2015_09_08_17_53_28_538x200.jpg](/images/2015_09_08_17_53_28_538x200.jpg)

完成配置以后，点击"开始安装"，就可以进入到CentOS7的安装界面了，如图所示:    
![/images/2015_09_08_17_56_04_636x477.jpg](/images/2015_09_08_17_56_04_636x477.jpg)   

选择"Install CentOS 7"，进入到系统的安装过程。

### 安装时配置
安装时主要注意系统IP的配置，我们配置这台机器的IP地址为"10.17.20.2", 如图所示:    
![/images/2015_09_08_18_03_31_530x457.jpg](/images/2015_09_08_18_03_31_530x457.jpg)    

![/images/2015_09_08_18_03_43_531x281.jpg](/images/2015_09_08_18_03_43_531x281.jpg)   

创建我们需要的用户，用户名/密码分别为spacewalk/spacewalk123, 你可以自行替换为自己想要的用户名/密
码.    
![/images/2015_09_08_18_06_23_570x398.jpg](/images/2015_09_08_18_06_23_570x398.jpg)    

继续安装，直到系统提示重新启动，重新启动后我们将进入到下一章Spacewalk的安装。    
